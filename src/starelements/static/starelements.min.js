import*as f from"/static/datastar.js";const{effect:v}=f;let A=0;const g=a=>a.replace(/-([a-z])/g,(i,l)=>l.toUpperCase()),p=(a,i,l=d=>d)=>{const d={};for(const u of a.attributes)u.name.startsWith(i)&&(d[u.name.slice(i.length)]=l(u.value));return d},b={string:a=>a,int:a=>parseInt(a,10),float:a=>parseFloat(a),boolean:a=>a==="true"||a===""||a===!0,json:a=>JSON.parse(a)};function E(a){let i="string",l=null;for(const u of a.split("|"))u in b?i=u:u.startsWith("=")&&(l=u.slice(1));const d=b[i];return{type:i,parse:d,default:l!==null?d(l):null}}export function initStarElements(){for(const a of document.querySelectorAll("template")){const i=Array.from(a.attributes).find(l=>l.name.startsWith("data-star:"));i&&x(i.name.replace("data-star:",""),a)}}function x(a,i){const l=p(i,"data-signal:",E),d=p(i,"data-import:"),u=p(i,"data-script:"),$=i.hasAttribute("data-shadow-open")||i.hasAttribute("data-shadow-closed"),w=i.hasAttribute("data-shadow-closed")?"closed":"open",S=i.content.querySelector("script:not([data-static])")?.textContent??"",m=i.content.querySelector("script[data-static]");if(m)try{new Function(m.textContent)()}catch(_){console.error(`[starelements] Static script error in ${a}:`,_)}class y extends HTMLElement{static observedAttributes=Object.keys(l);constructor(){super();const t=this.getAttribute("data-star-id");this._namespace=t||`_star_${a.replace(/-/g,"_")}_id${A++}`,this._hydrating=!!t,this._cleanups=[],this._imports={},this._connected=!1}_namespaceSignalRefs(t){return t.replace(/\$\$([a-z_][a-z0-9_]*)/gi,(e,s)=>`$${this._namespace}_${s}`)}async connectedCallback(){if(await this._loadImports(),this._signalValues=this._buildSignalValues(),!this._hydrating){const t=i.content.cloneNode(!0);for(const e of t.querySelectorAll("script"))e.remove();this._rewriteSignals(t),this._prepopulateText(t),$?this.attachShadow({mode:w}).appendChild(t):this.appendChild(t)}this._initSignals(),this._triggerDatastarScan(),this._runSetup(S),this._connected=!0,this.style.visibility="",this.setAttribute("data-star-ready","")}disconnectedCallback(){for(const t of this._cleanups)try{t()}catch(e){console.error(e)}this._cleanups=[],this._removeSignals()}attributeChangedCallback(t,e,s){if(e===s||!this._connected)return;const n=l[t],r=`${this._namespace}_${g(t)}`;f.mergePatch({[r]:n?n.parse(s):s})}async _loadImports(){for(const[e,s]of Object.entries(d)){if(!window[e])try{const n=await import(s);window[e]=n}catch(n){console.error(`[starelements] Failed to load ${e} from ${s}:`,n)}this._imports[e]=window[e]}const t=e=>{const s=e.charAt(0).toUpperCase()+e.slice(1);return window[e]||window[s]||window[e.toUpperCase()]};for(const[e,s]of Object.entries(u))t(e)||await new Promise((n,r)=>{const o=document.createElement("script");o.src=s,o.onload=()=>n(),o.onerror=()=>r(new Error(`Failed to load ${e} from ${s}`)),document.head.appendChild(o)}).catch(n=>console.error(`[starelements] ${n.message}`)),this._imports[e]=t(e)}_rewriteSignals(t){const e=s=>{if(s.attributes){const n=[];for(const r of s.attributes)if(r.name==="data-ref"&&r.value)r.value=`${this._namespace}_${r.value}`;else if(r.name.startsWith("data-computed:")){const o=r.name.slice(14),c=`data-computed:${this._namespace}_${o}`,h=this._namespaceSignalRefs(r.value);n.push([r.name,c,h])}else r.value.includes("$$")&&(r.value=this._namespaceSignalRefs(r.value));for(const[r,o,c]of n)s.removeAttribute(r),s.setAttribute(o,c)}s.childNodes?.forEach(e)};e(t)}_buildSignalValues(){const t={};for(const[e,s]of Object.entries(l)){const n=this.getAttribute(e);t[g(e)]=n!==null?s.parse(n):s.default}return t}_prepopulateText(t){const e=this._namespace+"_";for(const s of t.querySelectorAll("[data-text]")){const n=s.getAttribute("data-text").match(/\$([a-z_][a-z0-9_]*)/i);if(n?.[1]?.startsWith(e)){const r=n[1].slice(e.length);r in this._signalValues&&(s.textContent=String(this._signalValues[r]))}}}_initSignals(){const t=Object.fromEntries(Object.entries(this._signalValues).map(([e,s])=>[`${this._namespace}_${e}`,s]));f.mergePatch(t),this.setAttribute("data-signals",JSON.stringify(t))}_removeSignals(){const t=document.createElement("div");t.setAttribute("data-signals",JSON.stringify({[this._namespace]:null})),t.style.display="none",document.body.appendChild(t),setTimeout(()=>t.remove(),0)}_runSetup(t){if(!t.trim())return;const e={},s=o=>this.querySelector(`[data-ref="${this._namespace}_${o}"]`),n=this._namespace,r=new Proxy({},{has:(o,c)=>typeof c=="string"&&c.startsWith("$$")?!0:Reflect.has(o,c),get:(o,c)=>{if(typeof c=="string"&&c.startsWith("$$")){const h=`${n}_${c.slice(2)}`;return f.getPath(h)}return Reflect.get(o,c)},set:(o,c,h)=>{if(typeof c=="string"&&c.startsWith("$$")){const C=`${n}_${c.slice(2)}`;return f.mergePatch({[C]:h}),!0}return Reflect.set(o,c,h)}});try{const o=`with(sp) { ${t} }`;new Function("el","onCleanup","actions","refs","effect","sp","datastar",...Object.keys(this._imports),o)(this,c=>this._cleanups.push(c),e,s,v,r,f,...Object.values(this._imports)),this._actions=e}catch(o){console.error(`[starelements] Setup error in ${a}:`,o)}}_triggerDatastarScan(){this.dispatchEvent(new CustomEvent("datastar:scan",{bubbles:!0,detail:{root:this}}))}emit(t,e){this.dispatchEvent(new CustomEvent(t,{detail:e,bubbles:!0,cancelable:!0,composed:!1}))}}customElements.define(a,y)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",initStarElements):initStarElements();
